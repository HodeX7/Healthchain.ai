name: Fabric Network Validation

on:
  push:
    branches: [ main, feature/* ]
  pull_request:
    branches: [ main ]

jobs:
  validate-configuration:
    name: Validate Network Configuration
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check required files exist
        run: |
          echo "Checking for required configuration files..."
          
          # Check crypto-config.yaml
          if [ ! -f "network/organizations/cryptogen/crypto-config.yaml" ]; then
            echo "âŒ ERROR: crypto-config.yaml not found"
            exit 1
          fi
          echo "âœ… crypto-config.yaml found"
          
          # Check docker-compose.yml
          if [ ! -f "network/docker/docker-compose.yml" ]; then
            echo "âŒ ERROR: docker-compose.yml not found"
            exit 1
          fi
          echo "âœ… docker-compose.yml found"
          
          # Check startup scripts
          if [ ! -f "network/scripts/01-generate-crypto.sh" ]; then
            echo "âŒ ERROR: 01-generate-crypto.sh not found"
            exit 1
          fi
          echo "âœ… 01-generate-crypto.sh found"
          
          if [ ! -f "network/scripts/02-start-network.sh" ]; then
            echo "âŒ ERROR: 02-start-network.sh not found"
            exit 1
          fi
          echo "âœ… 02-start-network.sh found"
      
      - name: Validate YAML syntax
        run: |
          echo "Validating YAML files..."
          
          # Install yamllint
          pip install yamllint
          
          # Validate crypto-config.yaml
          yamllint -d "{extends: default, rules: {line-length: {max: 120}}}" \
            network/organizations/cryptogen/crypto-config.yaml
          echo "âœ… crypto-config.yaml is valid YAML"
          
          # Validate docker-compose.yml
          yamllint -d "{extends: default, rules: {line-length: {max: 200}}}" \
            network/docker/docker-compose.yml
          echo "âœ… docker-compose.yml is valid YAML"
      
      - name: Validate crypto-config structure
        run: |
          echo "Validating crypto-config.yaml structure..."
          
          # Check for required organizations
          if ! grep -q "Name: Orderer" network/organizations/cryptogen/crypto-config.yaml; then
            echo "âŒ ERROR: Orderer organization not found"
            exit 1
          fi
          
          for org in PatientOrg HospitalAOrg HospitalBOrg LabOrg PharmacyOrg InsuranceOrg; do
            if ! grep -q "Name: $org" network/organizations/cryptogen/crypto-config.yaml; then
              echo "âŒ ERROR: $org not found in crypto-config.yaml"
              exit 1
            fi
            echo "âœ… $org configured"
          done
      
      - name: Validate docker-compose services
        run: |
          echo "Validating docker-compose.yml services..."
          
          # Check for orderer
          if ! grep -q "orderer.orderer.healthchain.com" network/docker/docker-compose.yml; then
            echo "âŒ ERROR: Orderer service not found"
            exit 1
          fi
          echo "âœ… Orderer service configured"
          
          # Check for all peer services
          for peer in patient hospitalA hospitalB lab pharmacy insurance; do
            if ! grep -q "peer0.$peer.healthchain.com" network/docker/docker-compose.yml; then
              echo "âŒ ERROR: Peer $peer not found"
              exit 1
            fi
            echo "âœ… Peer $peer configured"
          done
          
          # Check for CouchDB services
          for db in patient hospitalA hospitalB lab pharmacy insurance; do
            if ! grep -q "couchdb.$db" network/docker/docker-compose.yml; then
              echo "âŒ ERROR: CouchDB for $db not found"
              exit 1
            fi
            echo "âœ… CouchDB $db configured"
          done
          
          # Check for CLI container
          if ! grep -q "container_name: cli" network/docker/docker-compose.yml; then
            echo "âŒ ERROR: CLI container not found"
            exit 1
          fi
          echo "âœ… CLI container configured"
      
      - name: Validate port configurations
        run: |
          echo "Validating port configurations..."
          
          # Check for required ports
          declare -A ports=(
            ["7050"]="Orderer"
            ["7051"]="PatientOrg Peer"
            ["8051"]="HospitalAOrg Peer"
            ["9051"]="HospitalBOrg Peer"
            ["10051"]="LabOrg Peer"
            ["11051"]="PharmacyOrg Peer"
            ["12051"]="InsuranceOrg Peer"
          )
          
          for port in "${!ports[@]}"; do
            if ! grep -q "$port:$port" network/docker/docker-compose.yml; then
              echo "âŒ ERROR: Port $port for ${ports[$port]} not found"
              exit 1
            fi
            echo "âœ… Port $port configured for ${ports[$port]}"
          done
      
      - name: Check scripts are executable
        run: |
          echo "Checking script permissions..."
          
          if [ ! -x "network/scripts/01-generate-crypto.sh" ]; then
            echo "âŒ ERROR: 01-generate-crypto.sh is not executable"
            exit 1
          fi
          echo "âœ… 01-generate-crypto.sh is executable"
          
          if [ ! -x "network/scripts/02-start-network.sh" ]; then
            echo "âŒ ERROR: 02-start-network.sh is not executable"
            exit 1
          fi
          echo "âœ… 02-start-network.sh is executable"
      
      - name: Validate .gitignore
        run: |
          echo "Validating .gitignore..."
          
          # Check that crypto material is ignored
          if ! grep -q "ordererOrganizations" .gitignore; then
            echo "âš ï¸  WARNING: ordererOrganizations not in .gitignore"
          fi
          
          if ! grep -q "peerOrganizations" .gitignore; then
            echo "âš ï¸  WARNING: peerOrganizations not in .gitignore"
          fi
          
          echo "âœ… .gitignore validation complete"
      
      - name: Summary
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… All validation checks passed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Network Configuration Summary:"
          echo "  â€¢ 1 Orderer organization"
          echo "  â€¢ 6 Peer organizations"
          echo "  â€¢ 6 CouchDB instances"
          echo "  â€¢ 1 CLI container"
          echo "  â€¢ Total: 14 services"
          echo ""
          echo "Ready for deployment! ğŸš€"
