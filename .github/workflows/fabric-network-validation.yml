name: Fabric Network CI/CD

on:
  push:
    branches: [ main, feature/* ]

jobs:
  validate-and-build:
    name: Build and Validate Network (Skills 01 + 03)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Hyperledger Fabric binaries
        run: |
          echo "ðŸ“¦ Installing Fabric binaries..."
          cd network
          chmod +x install-fabric-binaries.sh
          ./install-fabric-binaries.sh
          
      - name: Download Fabric config files
        run: |
          echo "ðŸ“¥ Downloading Fabric config files..."
          mkdir -p network/config
          curl -sSL https://raw.githubusercontent.com/hyperledger/fabric/release-2.5/sampleconfig/core.yaml -o network/config/core.yaml
          curl -sSL https://raw.githubusercontent.com/hyperledger/fabric/release-2.5/sampleconfig/orderer.yaml -o network/config/orderer.yaml
          echo "âœ… Config files downloaded"
          
      - name: Run full network build
        run: |
          echo "ðŸš€ Running full Fabric network build..."
          cd network/scripts
          chmod +x full_build.sh
          ./full_build.sh
          
      - name: Verify deployment
        run: |
          echo "ðŸ” Verifying network deployment..."
          
          # Check containers
          RUNNING=$(docker ps --format '{{.Names}}' | wc -l)
          echo "Running containers: $RUNNING"
          
          if [ "$RUNNING" -ne 14 ]; then
            echo "âŒ Expected 14 containers, found $RUNNING"
            docker ps -a
            exit 1
          fi
          echo "âœ… All 14 containers running"
          
          # Check channel exists
          if [ ! -f network/channel-artifacts/healthchain-channel.block ]; then
            echo "âŒ Channel genesis block missing"
            exit 1
          fi
          echo "âœ… Channel genesis block created"
          
          # Verify one peer joined the channel (patient peer)
          export FABRIC_CFG_PATH=$PWD/network/config
          export CORE_PEER_TLS_ENABLED=true
          export CORE_PEER_LOCALMSPID="PatientOrgMSP"
          export CORE_PEER_TLS_ROOTCERT_FILE=$PWD/network/organizations/peerOrganizations/patient.healthchain.com/peers/peer0.patient.healthchain.com/tls/ca.crt
          export CORE_PEER_MSPCONFIGPATH=$PWD/network/organizations/peerOrganizations/patient.healthchain.com/users/Admin@patient.healthchain.com/msp
          export CORE_PEER_ADDRESS=localhost:7051
          
          CHANNELS=$(network/bin/peer channel list 2>&1 | grep healthchain-channel || echo "")
          if [ -z "$CHANNELS" ]; then
            echo "âŒ Peer not joined to healthchain-channel"
            exit 1
          fi
          echo "âœ… Peer joined to healthchain-channel"
          
      - name: Success Summary
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… SKILLS 01 + 03: NETWORK SETUP + CHANNEL CREATION COMPLETE!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Success Criteria Met:"
          echo "  âœ… 14 containers running (1 orderer + 6 peers + 6 CouchDBs + 1 CLI)"
          echo "  âœ… Channel 'healthchain-channel' created"
          echo "  âœ… Peers joined to channel"
          echo ""
          docker ps --format "table {{.Names}}\t{{.Status}}"
          echo ""
          echo "ðŸŽ‰ Ready for Skill 04: Private Data Collections!"
          
      - name: Cleanup on failure
        if: failure()
        run: |
          echo "âŒ Build failed. Showing logs..."
          docker ps -a
          echo ""
          echo "=== Orderer Logs ==="
          docker logs orderer.orderer.healthchain.com 2>&1 | tail -50 || true
          echo ""
          echo "=== Patient Peer Logs ==="
          docker logs peer0.patient.healthchain.com 2>&1 | tail -50 || true
          
      - name: Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up..."
          cd network/docker
          docker compose down -v || true
